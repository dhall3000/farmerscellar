<h1>Shopping Tote Addition</h1>


<% posting = nil %>
<% if params[:posting_id] != nil %>
  <% posting = Posting.find_by(id: params[:posting_id]) %>
<% end %>
<% if !@tote_item.nil? && !(@tote_item.posting_id).nil? %>
  <% posting = Posting.find_by(id: @tote_item.posting_id) %>
<% end %>
  
<% if posting != nil %>
  <% unit_kind = UnitKind.find_by(id: posting.unit_kind_id) %>
  <% producer = User.find_by(id: posting.user_id) %>
  <% provide(:title, producer.farm_name) %>

  <table class="table">
    <thead>
      <tr>
        <th class="text-center">Producer</th>
        <th class="text-center">Product</th>
        <th class="text-center">Price</th>   
        <th class="text-center">Unit</th>        
        <th class="text-center">Delivery Date</th>
      </tr>
    </thead>
    <tbody>
        <% farmInfo = "Producer has not provided info about their operation" %>
        <% if posting.user.description != nil %>
          <% farmInfo = "<u>Producer Description</u><p>" + posting.user.description %>
        <% end %>
        <% if !posting.user.website.blank? %>
          <% farmInfo = farmInfo + "<p>" + "<u>Producer Website</u><p><a href='" + posting.user.website + "' target='_blank'>" + posting.user.website + "</a>"%>
        <% end %>

        <tr>
          <td><a tabindex="0" class="btn btn-primary btn-block" role="button" data-html="true" data-toggle="popover" data-trigger="focus" data-content="<%=farmInfo%>"><%= User.find_by(id: posting.user_id).farm_name %></a></td>          
          <td><a tabindex="0" class="btn btn-primary btn-block" role="button" data-html="true" data-toggle="popover" data-trigger="focus" data-content="<%= posting.description %>"><%= Product.find_by(id: posting.product_id).name %></a></td>
          <td class="text-center"><%= number_to_currency(posting.price) %></td>
          <td class="text-center"><%= UnitKind.find_by(id: posting.unit_kind_id).name %></td>          
          <td class="text-center"><%= posting.delivery_date.strftime("%A %b %d, %Y") %></td>
        </tr>      
    </tbody>
  </table>  

  <div class="row">          
    <div class="col-xs-4 col-xs-offset-4">
      <% disabled = current_user.account_states.last.state != AccountState.states[:OK] %>    
      <%= form_for @tote_item do |f| %>
        <%= render partial: 'shared/error_messages_general', locals: { active_record_object: @tote_item } %>
        <div class="text-center">
          <%= f.label :quantity, "Quantity to add" %>
        </div>
        <%= f.number_field :quantity, class: "form-control" %>
        <%= f.number_field :price, value: posting.price, hidden: true %>
        <%= f.number_field :status, value: ToteItem.states[:ADDED], hidden: true %>
        <%= f.number_field :posting_id, value: posting.id, hidden: true %>
        <%= f.number_field :user_id, value: current_user.id, hidden: true %>

        <%= f.submit "Add to shopping tote", class: "btn btn-primary", disabled: disabled %>
        <% if disabled %>
          <%= "your account is on hold, most likely due to a positive balance on your account. please pay your balance before continuing shopping." %>
        <% end %>
      <% end %>
    </div>
  </div>
<% end %>