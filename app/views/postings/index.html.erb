<% provide(:title, 'Postings') %>

<h1>Postings</h1>

<% if @postings != nil && @postings.any? %>  

<div class="row">
  <div class="col-xs-12">

  <table class="table">
    <thead>
      <tr>
        <th class="text-center"><h2></h2></th>        
        <th class="text-center"><h2></h2></th>   
        <% if current_user.account_type == User.types[:ADMIN] %>
          <th class="text-center">Delivery Date</th>
          <th class="text-center"></th>
          <th class="text-center">Do delivery</th>
        <% end %>
      </tr>
    </thead>
    <tbody>
      <% @postings.each do |posting| %> 

        <% farmInfo = "" %>

        <% if posting.description != nil %>
          <% farmInfo = "<u>Product Info</u><p>" + posting.description %>
        <% end %>

        <% if posting.user.description != nil %>
          <% farmInfo = farmInfo + "<p><u>Producer Description</u><p>" + posting.user.description %>
        <% end %>        

        <% if !posting.user.website.blank? %>
          <% farmInfo = farmInfo + "<p>" + "<u>Producer Website</u><p><a href='" + posting.user.website + "' target='_blank'>" + posting.user.website + "</a>"%>
        <% end %>

        <% if farmInfo == "" %>
          <% farmInfo = "Producer has not provided info about their operation" %>
        <% end %>

        <tr>
        
          <td class="text-center"><a tabindex="0" class="btn" role="button" data-html="true" data-toggle="popover" data-trigger="click" data-content="<%=farmInfo%>"> <p class="lead"> <%= Product.find_by(id: posting.product_id).name %> </p> <p class="small"> <%= User.find_by(id: posting.user_id).farm_name %> </p></a>
          <% if posting.posting_recurrence != nil && posting.posting_recurrence.on == true && posting.posting_recurrence.frequency > 0 %>                        
            <span class="glyphicon glyphicon-repeat" aria-hidden="true"></span>
          <% end %>
          </td>
          
          <td class="text-center">
            <div>
              <div class="price">
                <p><%= number_to_currency(posting.price) %> / <%= UnitKind.find_by(id: posting.unit_kind_id).name %></p>
              </div>
              <p><%= link_to "Buy", new_tote_item_path(posting_id: posting.id), class: "btn btn-primary" %></p>
            </div>
          </td>
          
          <% if current_user.account_type == User.types[:ADMIN] %>
            <td class="text-center"><%= posting.delivery_date.strftime("%a %b %d") %></td>
            <td class="text-center"><%= link_to "Edit", edit_posting_path(posting) %></td>
            <td class="text-center"><%= link_to "Go!", tote_items_next_path( tote_item: {posting_id: posting.id}) %></td>
          <% end %>

        </tr>
      <% end %>
    </tbody>
  </table>  

</div>
</div>  
<% end %>